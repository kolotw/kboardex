<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>實驗題目分派頁面</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; font-size: 16px; }
    input, button { font-size: 1rem; }
    input { padding: 0.5em; }
    button { padding: 0.5em 1em; margin-left: 10px; }
    .task { margin-top: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; }
    .task h3 { margin-top: 0; font-size: 1.1rem; }
    .link-btn { margin-top: 5px; display: inline-block; background: #007bff; color: white; padding: 6px 12px; text-decoration: none; border-radius: 4px; font-size: 1rem; }
  </style>
</head>
<body>
  <h1>輸入學號以獲得實驗題目</h1>
  <input type="text" id="studentID" placeholder="請輸入學號">
  <button onclick="generateTasks()">產生題目</button>
  <div id="taskContainer"></div>

<script>
const tasks = ['G1','G2','G3','G4','G5','G6','G7','G8'];
const githubBase = 'https://kolotw.github.io/kboardex/tasks/';
const Ctask = 'G9';

async function fetchTaskText(taskID) {
  const url = `${githubBase}${taskID}.csv`;
  const res = await fetch(url);
  const text = await res.text();
  return text.split('\n').filter(line => line.trim()).slice(0, 10).join('\n');
}

const webTEMLinks = {};
['K', 'G'].forEach(prefix => {
  for (let i = 1; i <= 12; i++) {
    const id = `${prefix}S${i}`;
    webTEMLinks[id] = `http://www.asarif.com/resources/WebTEM/#uo=ttf&e=kolo.tw@gmail.com&c=${prefix}board&s=${i}&p=10&kb=tf&st=fftffffff&m=ttttttttttttttttttttttttt&im=ffffffff&o=ffftffffftttffftff`;
  }
});

function getRandomElements(array, count, exclude = []) {
  const filtered = array.filter(item => !exclude.includes(item));
  const shuffled = filtered.sort(() => 0.5 - Math.random());
  return shuffled.slice(0, count);
}

async function generateTasks() {
  const id = document.getElementById('studentID').value.trim();
  if (!id || isNaN(id)) return alert('請輸入正確學號！');

  const isOdd = parseInt(id.slice(-1)) % 2 === 1;
  const Afirst = isOdd ? 'Kboard' : 'Gboard';
  const Bsecond = isOdd ? 'Gboard' : 'Kboard';

  const Agroup = getRandomElements(tasks, 1);
  const Bgroup = getRandomElements(tasks, 1, Agroup);

  const Ablock = Array(5).fill(Agroup[0])
    .concat(Array(2).fill(Bgroup[0]))
    .concat(Array(2).fill(Agroup[0]))
    .concat(Array(3).fill(Ctask));

  const container = document.getElementById('taskContainer');
  container.innerHTML = '';

  const boardOrder = [Afirst, Bsecond];

  for (const board of boardOrder) {
    const subtitle = document.createElement('h2');
    subtitle.textContent = `${board} 測驗`;
    container.appendChild(subtitle);

    for (let i = 0; i < 12; i++) {
      const taskID = Ablock[i];
      const taskNum = i + 1;
      const webID = (board[0] === 'K' ? 'K' : 'G') + 'S' + taskNum;
      const taskText = await fetchTaskText(taskID);
      const webTEMURL = webTEMLinks[webID];

      const div = document.createElement('div');
      div.className = 'task';
      div.innerHTML = `
        <h3>第 ${taskNum} 題（${board}）</h3>
        <button onclick="navigator.clipboard.writeText(\`${taskText}\`)">複製題目內容</button><br><br>
        <a href="${webTEMURL}" target="_blank" class="link-btn">前往 WebTEM 測驗</a>
      `;
      container.appendChild(div);
    }
  }
}
</script>
</body>
</html>
